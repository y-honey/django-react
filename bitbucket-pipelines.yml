clone:
  depth: full

definitions:
  services:
    docker:
      memory: 7128
  caches:
    pnpmbackend: $BITBUCKET_CLONE_DIR/.pnpm-store
    pnpmdocs: $BITBUCKET_CLONE_DIR/.pnpm-store
    pnpmwebapp: $BITBUCKET_CLONE_DIR/.pnpm-store
    pnpmworkers: $BITBUCKET_CLONE_DIR/.pnpm-store
    clis: ~/.clicache
    sonar: ~/.sonar/cache

  scripts:
    initializeStep: &initializeStep
                      cp .env.test .env
                      && npm -g config set user root
                      && curl -fsSL https://get.pnpm.io/install.sh | env PNPM_VERSION=7.25.0 bash -
                      && export PNPM_HOME="/root/.local/share/pnpm"
                      && export PATH="$PNPM_HOME:$PATH"

    setupAwsCli: &setupAwsCli
                   export AWS_CLI_VERSION=2.8.8
                   export AWS_CLI_DEST_PATH=~/.clicache/awscli-${AWS_CLI_VERSION}.zip
                   mkdir -p AWS_CLI_DEST_PATH
                   && wget --no-verbose --no-clobber "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-${AWS_CLI_VERSION}.zip" \
                   && --output-document "${AWS_CLI_DEST_PATH}" || true
                   && unzip "${AWS_CLI_DEST_PATH}"
                   && rm "${AWS_CLI_DEST_PATH}"
                   && /bin/sh ./aws/install
                   && aws --version
    installWebappDeps: &installWebappDeps
                         pnpm install
                         --include-workspace-root
                         --frozen-lockfile
                         --filter=webapp...

pipelines:
  default:
    - parallel:
        - step:
            name: Push code to CodeCommit
            clone:
              depth: full
            script:
              - git remote add codecommit "$CODE_COMMIT_REPO"
              - git push --force -u codecommit "$BITBUCKET_BRANCH"
              - git push codecommit --tags --force

        - step:
            name: Lint & test web app
            image: atlassian/default-image:4
            size: 2x
            script:
              - *initializeStep
              - *installWebappDeps
              - node_modules/.bin/nx run webapp:lint
              - node_modules/.bin/nx run webapp:test --watchAll=false --maxWorkers=20%
              - pipe: sonarsource/sonarcloud-scan:1.4.0
                variables:
                  SONAR_TOKEN: ${SONAR_TOKEN}
                  EXTRA_ARGS: '-Dsonar.projectBaseDir=packages/webapp'
            caches:
              - pnpmwebapp
              - clis
              - sonar
        - step:
            name: Build web app
            image: atlassian/default-image:4
            script:
              - *initializeStep
              - *installWebappDeps
              - node_modules/.bin/nx run webapp:build:app
            caches:
              - pnpmwebapp
              - clis

        - step:
            name: Build docs
            image: atlassian/default-image:4
            script:
              - *initializeStep
              - pnpm install
                --include-workspace-root
                --frozen-lockfile
                --filter=docs...
              - node_modules/.bin/nx run docs:build
            caches:
              - pnpmdocs
              - clis

        - step:
            name: Test backend
            image: atlassian/default-image:3
            size: 2x
            script:
              - *initializeStep
              - *setupAwsCli
              - pnpm install
                --include-workspace-root
                --frozen-lockfile
                --filter=backend...
              - node_modules/.bin/nx run backend:test
              - pipe: sonarsource/sonarcloud-scan:1.4.0
                variables:
                  SONAR_TOKEN: ${SONAR_TOKEN}
                  EXTRA_ARGS: '-Dsonar.projectBaseDir=packages/backend'
            services:
              - docker
            caches:
              - docker
              - pnpmbackend
              - clis
              - sonar

        - step:
            name: Test async-workers
            image: atlassian/default-image:3
            size: 2x
            script:
              - *initializeStep
              - *setupAwsCli
              - pnpm install
                --include-workspace-root
                --frozen-lockfile
                --filter=workers...
              - node_modules/.bin/nx run workers:test
              - pipe: sonarsource/sonarcloud-scan:1.4.0
                variables:
                  SONAR_TOKEN: ${SONAR_TOKEN}
                  EXTRA_ARGS: '-Dsonar.projectBaseDir=packages/workers'
            services:
              - docker
            caches:
              - docker
              - pnpmworkers
              - clis
              - sonar
